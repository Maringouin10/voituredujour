<!DOCTYPE html>
<html lang="fr">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1692192577489772"
     crossorigin="anonymous"></script>
<link rel="icon" href="minilogo.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voiture du Jour</title>
<style>
  body { font-family: Helvetica, Arial, sans-serif; background-color: #f4f6f8; margin:0; padding:0; color:#0f1724; }
  header { background: linear-gradient(90deg,#0f1724,#1f2937); color:#fff; text-align:center; padding:40px 20px; }
  header h1 { margin:0; font-size:2.4em; font-weight:700; letter-spacing:0.4px; }
  header p { font-size:14px; color:#cbd5e1; margin-top:10px; }
  main { max-width:900px; margin:40px auto; padding:0 20px; }
  .subscribe { text-align:center; margin-bottom:40px; }
  .subscribe-buttons { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }
  .subscribe a { display:inline-block; background:#111827; color:#fff; text-decoration:none; padding:12px 24px; border-radius:8px; font-weight:700; transition:background 0.2s ease; }
  .subscribe a:hover { background:#1f2937; }
  .alert-message { text-align:center; margin:15px 0; color:#b91c1c; font-weight:600; }
  .email-input { text-align:center; margin-bottom:20px; }
  .email-input input { padding:10px; width:250px; border-radius:6px; border:1px solid #ccc; }
  .email-input button { padding:10px 20px; margin-left:10px; border:none; border-radius:6px; background:#111827; color:#fff; cursor:pointer; font-weight:700; }
  section#cars h2 { font-size:20px; text-transform:uppercase; color:#374151; letter-spacing:1px; border-bottom:2px solid #e5e7eb; padding-bottom:6px; margin-bottom:20px; }
  .car-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:30px; overflow:hidden; }
  .car-images { display:flex; flex-wrap:wrap; gap:10px; background:#f9fafb; padding:10px; }
  .car-images img { width:49%; border-radius:8px; object-fit:cover; }
  .car-info { padding:20px; }
  .car-info h2 { font-size:22px; color:#0f1724; margin:0 0 8px 0; }
  .car-info p { margin:8px 0; line-height:1.5; color:#374151; }
  .car-info b { color:#111827; }
  .exclusive-star { color: gold; margin-left:5px; font-size:1.2em; vertical-align:top; }
  footer { font-size:13px; color:#9aa3b2; text-align:center; padding:30px 20px; }
  footer a { color:#9aa3b2; text-decoration:underline; }
  @media(max-width:700px){ .car-images img{width:100%;} .subscribe-buttons{flex-direction:column; align-items:center;} }
</style>
</head>

<body>
<header>
  <h1>Voiture du Jour</h1>
  <p>Sélection exclusive — chaque jour une nouvelle histoire automobile</p>
</header>

<main>
  <div class="subscribe">
    <div class="subscribe-buttons">
      <a href="qui-sommes-nous.html">Qui sommes-nous</a>
      <a href="https://n8n1.voituredujour.duckdns.org/form/af35f49b-b752-4a72-92d8-9975d17b26da" target="_blank">S’abonner</a>
      <a href="https://n8n1.voituredujour.duckdns.org/webhook/cce1f3ed-5fb0-4446-88cc-77fe05995cad/chat">Parler à un expert IA</a>
    </div>
  </div>

  <section id="cars">
    <h2>Les voitures précédentes</h2>
    <div id="alert-container" class="alert-message">
      Certaines voitures sont réservées aux abonnés. Entrez votre email pour y accéder.
    </div>
    <div class="email-input" id="email-box">
      <input type="email" id="userEmail" placeholder="Entrez votre email">
      <button onclick="filterCars()">Voir les voitures réservées</button>
    </div>
    <div id="car-list"></div>
    <div id="pagination-controls" style="text-align: center; margin-top: 20px;"></div>
  </section>
</main>

<footer>
    <p>
        <a href="qui-sommes-nous.html">Qui sommes-nous</a> |
        <a href="index.html">Accueil</a> |
        <a href="Politique_de_Confidentialité_et_Conditions_dUtilisation.html">Politique de Confidentialité et Conditions d'Utilisation</a> |
        <a href="mailto:voituredujour@gmail.com">Contact</a>
    </p>
    <p>&copy; 2025 Voiture du Jour. Tous droits réservés.</p>
  Certaines images peuvent être générées par l’IA. Vérifiez les informations avant de partager.<br>
  <a href="https://n8n1.voituredujour.duckdns.org/form/bb5f6955-eb29-4acf-85f5-a71f636a0375">Se désabonner</a>
</footer>

<script>
const BASE_WEBHOOK_URL = "https://n8n1.voituredujour.duckdns.org/webhook/";
const PAGE_NUMBER_ENDPOINT = "pagenumber";
const PAGE_ENDPOINT = "page";
const USER_INFO_ENDPOINT = "user";
const SUBSCRIBE_FORM_LINK = "https://n8n1.voituredujour.duckdns.org/form/af35f49b-b752-4a72-92d8-9975d17b26da";

let totalCars = 0;
let currentPage = 1;
const carsPerPage = 7;
let userLanguage = "French";
let isSubscriber = false;

const translations = {
    "French": { title:"Voiture du Jour", subtitle:"Sélection exclusive — chaque jour une nouvelle histoire automobile", previous_cars:"Les voitures précédentes", subscriber_only_warning:"Certaines voitures sont réservées aux abonnés. Entrez votre email pour y accéder.", email_placeholder:"Entrez votre email", show_reserved_cars:"Voir les voitures réservées", ia_generated_warning:"Certaines images peuvent être générées par l’IA. Vérifiez les informations avant de partager.", unsubscribe:"Se désabonner", subscribe_now:`L'accès aux voitures réservées est réservé aux abonnés. Merci de vous abonner : <a href="${SUBSCRIBE_FORM_LINK}" target="_blank">Formulaire d'inscription</a>`, all_cars_unlocked:"Vous voyez toutes les voitures réservées aux abonnés.", power:"Puissance", features:"Caractéristiques", history:"Histoire" },
    "English": { title:"Car of the Day", subtitle:"Exclusive selection — a new automotive story every day", previous_cars:"Previous Cars", subscriber_only_warning:"Some cars are reserved for subscribers. Enter your email to access them.", email_placeholder:"Enter your email", show_reserved_cars:"Show reserved cars", ia_generated_warning:"Some images may be AI-generated. Please verify information before sharing.", unsubscribe:"Unsubscribe", subscribe_now:`Access to reserved cars is for subscribers only. Please subscribe: <a href="${SUBSCRIBE_FORM_LINK}" target="_blank">Registration Form</a>`, all_cars_unlocked:"You are seeing all subscriber-only cars.", power:"Power", features:"Features", history:"History" }
};

function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i=0;i < ca.length;i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

function setLanguage(lang) {
    userLanguage = lang;
    const t = translations[lang] || translations["French"];
    document.title = t.title;
    document.querySelector("header h1").textContent = t.title;
    document.querySelector("header p").textContent = t.subtitle;
    document.querySelector("section#cars h2").textContent = t.previous_cars;
    document.getElementById("alert-container").textContent = t.subscriber_only_warning;
    document.getElementById("userEmail").placeholder = t.email_placeholder;
    document.querySelector(".email-input button").textContent = t.show_reserved_cars;
}

async function fetchWebhook(endpoint, params = {}) {
    try {
        const urlParams = new URLSearchParams(params).toString();
        const url = `${BASE_WEBHOOK_URL}${endpoint}?${urlParams}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return await res.json();
    } catch (e) {
        console.error(`Erreur fetchWebhook (${endpoint}):`, e);
        return null;
    }
}

async function initializeCars() {
    const emailBox = document.getElementById("email-box");
    const userCookie = getCookie("voituredujour_user");
    let userEmail = null;
    isSubscriber = false;
    userLanguage = "French";

    if (userCookie) {
        try {
            const { email } = JSON.parse(userCookie);
            userEmail = email;
            const userData = await fetchWebhook(USER_INFO_ENDPOINT, { email: userEmail }); 
            if (userData && userData.isSubscriber) {
                isSubscriber = true;
                userLanguage = userData.lang || "French";
                emailBox.style.display = "none";
            } else {
                setCookie("voituredujour_user","",-1); 
            }
        } catch { setCookie("voituredujour_user","",-1); }
    }
    
    setLanguage(userLanguage);
    const pageNumberResponse = await fetchWebhook(PAGE_NUMBER_ENDPOINT, { lang: userLanguage, isSubscriber });
    if (pageNumberResponse && pageNumberResponse.page) {
        totalCars = parseInt(pageNumberResponse.page, 10);
    }

    displayCars(1);
    setupPagination();
}

function createCarCard(car) {
    const star = (car.excusivite === true) ? '<span class="exclusive-star">★</span>' : '';
    const t = translations[userLanguage] || translations["French"];
    const card = document.createElement("div");
    card.className = "car-card";

    const imageHTML = isSubscriber
        ? `
            <img src="${car.imgprincipal}" alt="${car.name}">
            <img src="${car.imgsecondaire}" alt="${car.name}">
          `
        : `<img src="${car.imgprincipal}" alt="${car.name}">`;

    card.innerHTML = `
    <div class="car-images">
        ${imageHTML}
    </div>
    <div class="car-info">
        <h2>${car.name}${star}</h2>
        <p><b>${t.power}:</b> ${car.cheveau} chevaux</p>
        <p><b>${t.features}:</b> ${car.spec}</p>
        <p><b>${t.history}:</b> <i>${car.histoire}</i></p>
    </div>
    `;
    return card;
}

async function displayCars(page = 1) {
    const list = document.getElementById("car-list");
    list.innerHTML = `<p style="text-align:center; color:#111827;">Chargement des voitures...</p>`;
    currentPage = page;
    const carData = await fetchWebhook(PAGE_ENDPOINT, { page: currentPage, limit: carsPerPage, lang: userLanguage, isSubscriber: isSubscriber });
    list.innerHTML = "";
    if (carData && Array.isArray(carData) && carData.length > 0) {
        carData.forEach(car => list.appendChild(createCarCard(car)));
    } else {
        list.innerHTML = `<p style="text-align:center; color:#374151;">Aucune voiture trouvée ou erreur de chargement.</p>`;
    }
    const t = translations[userLanguage] || translations["French"];
    const alertBox = document.getElementById("alert-container");
    if(!isSubscriber) alertBox.innerHTML = t.subscribe_now;
    else alertBox.textContent = t.all_cars_unlocked;
    updatePaginationButtons();
}

function setupPagination() {
    const paginationControls = document.getElementById("pagination-controls");
    paginationControls.innerHTML = "";
    const pageCount = Math.ceil(totalCars / carsPerPage);
    if (pageCount <= 1) return;
    for (let i = 1; i <= pageCount; i++) {
        const button = document.createElement("button");
        button.innerText = i;
        button.onclick = () => displayCars(i);
        paginationControls.appendChild(button);
    }
    updatePaginationButtons();
}

function updatePaginationButtons() {
    const paginationControls = document.getElementById("pagination-controls");
    const buttons = paginationControls.getElementsByTagName("button");
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].style.padding = '8px 15px';
        buttons[i].style.margin = '0 5px';
        buttons[i].style.border = 'none';
        buttons[i].style.borderRadius = '6px';
        buttons[i].style.backgroundColor = '#111827';
        buttons[i].style.color = '#fff';
        buttons[i].style.cursor = 'pointer';
        buttons[i].style.fontWeight = '700';
        if (i + 1 === currentPage) {
            buttons[i].disabled = true;
            buttons[i].style.backgroundColor = '#374151';
        } else {
            buttons[i].disabled = false;
        }
    }
}

async function filterCars() {
    const email = document.getElementById("userEmail").value.trim().toLowerCase();
    if (!email) {
        alert("Veuillez entrer une adresse email.");
        return;
    }
    const userData = await fetchWebhook(USER_INFO_ENDPOINT, { email: email });
    isSubscriber = userData && userData.isSubscriber === true;
    const lang = userData ? (userData.lang || "French") : "French";
    if (isSubscriber) {
        setCookie("voituredujour_user", JSON.stringify({email}), 365);
        document.getElementById("email-box").style.display = "none";
    } else {
        setCookie("voituredujour_user","",-1);
        alert(translations[lang].subscribe_now.replace(/<[^>]*>/g, '').split(':')[0] + "."); 
    }
    setLanguage(lang);
    const pageNumberResponse = await fetchWebhook(PAGE_NUMBER_ENDPOINT, { lang: lang, isSubscriber: isSubscriber });
    if (pageNumberResponse && pageNumberResponse.page) {
        totalCars = parseInt(pageNumberResponse.page, 10);
    } else {
        totalCars = 0; 
    }
    displayCars(1);
    setupPagination();
}

initializeCars();
</script>
</body>
</html>

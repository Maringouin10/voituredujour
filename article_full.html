<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Complet</title>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            background:#f3f5f7;
            color:#0f1724;
            margin:0;
            padding:0;
            line-height: 1.7;
        }
        header {
            background: linear-gradient(90deg,#0f1724,#1f2937);
            color:#fff;
            text-align:center;
            padding:40px 20px 20px;
        }
        main {
            max-width:900px;
            margin:40px auto;
            padding:0 20px;
        }
        /* Style pour les images */
        .article-images-full {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .article-images-full img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            object-fit: cover;
        }
        /* Contenu de l'article formaté */
        #article-content-full p {
            margin-bottom: 20px;
            text-align: justify;
        }
        #article-content-full h3 {
            margin-top: 30px;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        #article-content-full ul {
            padding-left: 20px;
        }
        
        /* Sources et Bouton Retour */
        #sources-section {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        #sources-section h3 {
            color: #ff7f50;
        }
        #sources-section ul {
            list-style-type: none;
            padding-left: 0;
        }
        #sources-section li {
            margin-bottom: 10px;
            word-break: break-all; 
        }
        #sources-section a {
            color: #1f2937;
            text-decoration: none;
            font-weight: 500;
        }
        #sources-section a:hover {
            text-decoration: underline;
            color: #ff7f50;
        }
        
        /* Bouton Retour */
        .return-button {
            display: inline-block;
            margin: 20px 0 40px;
            padding: 12px 20px;
            background:#111827;
            color:#fff;
            border:none;
            border-radius:6px;
            cursor:pointer;
            font-weight:700;
            text-decoration: none;
        }
        .return-button:hover {
            background: #252e3d;
        }

        /* En-tête de l'article */
        .article-header {
            text-align: center;
        }
        .article-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #1f2937;
        }
        .article-header p {
            font-size: 1.1em;
            color: #6b7280;
        }
        .article-header .subject-badge {
            background-color: #ff7f50;
            color: white;
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        
        /* Styles pour Articles Similaires */
        #similar-articles-section {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        #similar-articles-section h3 {
            color: #1f2937;
            margin-bottom: 20px;
        }
        .similar-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .similar-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .similar-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .similar-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .similar-card-content {
            padding: 15px;
        }
        .similar-card-content h4 {
            margin-top: 0;
            font-size: 1.1em;
        }
        .similar-card-content p {
            font-size: 0.9em;
            color: #6b7280;
            margin: 5px 0 0;
            line-height: 1.4;
            max-height: 4.2em; /* 3 lignes max */
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>

<main id="article-main">
    <div id="loading-error" style="text-align: center; color: red;">
        Chargement...
    </div>
</main>

<script>
// Sauvegarde des données brutes de tous les articles
let allArticlesData = null;
// Index brut de l'article affiché actuellement
let currentArticleIndex = -1;


// Markdown → HTML (copiée de article.html)
function parseMarkdownToHTML(text) {
    if(!text) return "";
    let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    const lines = html.split('\n');
    let inList = false;
    html = lines.map(line => {
        const trimmed = line.trim();
        if(trimmed.startsWith('* ')){
            if(!inList){ inList = true; return '<ul><li>' + trimmed.substring(2) + '</li>'; }
            return '<li>' + trimmed.substring(2) + '</li>';
        } else {
            if(inList){ inList = false; return '</ul>' + line; }
            return line;
        }
    }).join('\n');
    if(inList) html += '</ul>';
    return html.replace(/##\s*(.*)/g, '<h3>$1</h3>');
}

// Fonction pour récupérer toutes les données stockées
function loadAllArticlesData() {
    const data = localStorage.getItem('allArticlesData');
    if (data) {
        try {
            allArticlesData = JSON.parse(data);
        } catch(e) {
            console.error("Erreur de parsing des données de tous les articles:", e);
        }
    }
}

// Fonction pour retourner à la page d'accueil avec le nouvel article sélectionné
function selectSimilarArticle(index) {
    const selectedArticle = {};
    
    // Recréer l'objet article en utilisant l'index brut
    for (const key in allArticlesData) {
        if (Array.isArray(allArticlesData[key])) {
            selectedArticle[key] = allArticlesData[key][index];
        }
    }
    
    // Sauvegarder le nouvel article sélectionné
    localStorage.setItem('selectedArticle', JSON.stringify(selectedArticle));
    
    // Recharger la page actuelle pour afficher le nouvel article
    window.location.reload(); 
}


// Génère le HTML pour les sources
function renderSources(sourceString) {
    if (!sourceString) {
        return '<p>Aucune source n\'a été fournie pour cet article.</p>';
    }
    
    let sourcesArray = [];
    try {
        sourcesArray = JSON.parse(sourceString);
    } catch(e) {
        return `<p>L'information présentée ici est basée sur la source suivante : <a href="${sourceString}" target="_blank" rel="noopener noreferrer">${sourceString}</a></p>`;
    }

    if (sourcesArray.length === 0) {
        return '<p>Aucune source n\'a été fournie pour cet article.</p>';
    }

    let listHTML = '<ul>';
    sourcesArray.forEach((url, index) => {
        listHTML += `<li>${index + 1}. <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></li>`;
    });
    listHTML += '</ul>';

    return listHTML;
}

// NOUVELLE FONCTION : Afficher les articles de la même catégorie
function renderSimilarArticles(currentArticle, articleIndex) {
    if (!allArticlesData || !allArticlesData.subject || allArticlesData.subject.length === 0) {
        return '';
    }
    
    const category = currentArticle.subject;
    const currentTitle = currentArticle.titre;
    
    if (!category || category === 'Général') {
         return '<p>Aucun autre article similaire à afficher.</p>';
    }
    
    const similarArticles = [];
    const articleCount = allArticlesData.titre.length;

    // Parcourir tous les articles pour trouver ceux qui correspondent à la catégorie
    for (let i = 0; i < articleCount; i++) {
        // Exclure l'article actuellement affiché et filtrer par catégorie
        if (allArticlesData.subject[i] === category && allArticlesData.titre[i] !== currentTitle) {
             const articleResume = allArticlesData.resume[i];
             let firstResumeParagraph = '';
             try {
                // Essayer de parser le résumé comme un tableau, prendre le premier élément
                const resumeArray = JSON.parse(articleResume);
                if (Array.isArray(resumeArray) && resumeArray.length > 0) {
                     firstResumeParagraph = parseMarkdownToHTML(resumeArray[0]);
                }
             } catch(e) {
                 // Si le parsing échoue, utiliser le résumé brut
                 firstResumeParagraph = parseMarkdownToHTML(articleResume);
             }
             
             similarArticles.push({
                 index: i, // Index brut pour le rechargement
                 title: allArticlesData.titre[i],
                 image: allArticlesData.img1[i],
                 resume: firstResumeParagraph
             });
        }
    }
    
    if (similarArticles.length === 0) {
        return `<p>Aucun autre article trouvé dans la catégorie **${category}**.</p>`;
    }
    
    let html = '<div class="similar-card-container">';
    // Limiter l'affichage à 3 ou 4 articles pour ne pas surcharger la page
    const articlesToShow = similarArticles.slice(0, 4); 

    articlesToShow.forEach(article => {
        html += `
            <div class="similar-card" onclick="selectSimilarArticle(${article.index})">
                <img src="${article.image}" alt="${article.title}">
                <div class="similar-card-content">
                    <h4>${article.title}</h4>
                    <p>${article.resume}</p>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    return `
        <div id="similar-articles-section">
            <h3>Articles similaires dans la catégorie "${category}"</h3>
            ${html}
        </div>
    `;
}


// Fonction principale pour charger et afficher l'article
function loadFullArticle() {
    const articleData = localStorage.getItem('selectedArticle');
    const container = document.getElementById('article-main');
    
    loadAllArticlesData(); // Charger toutes les données
    
    if (!articleData) {
        // ... (Gestion de l'erreur) ...
        container.innerHTML = `
            <div style="text-align:center; margin-top:50px;">
                <p style="color:red;">Erreur : Aucune donnée d'article trouvée. Veuillez d'abord sélectionner un article sur la page d'accueil.</p>
                <a href="article.html" class="return-button">Retour à l'accueil</a>
            </div>
        `;
        return;
    }

    try {
        const article = JSON.parse(articleData);
        
        const title = article.titre || 'Titre Inconnu';
        const fullContent = parseMarkdownToHTML(article.article) || '<p>Contenu de l\'article non disponible.</p>'; 
        const subject = article.subject || 'Général';
        const sourcesHTML = renderSources(article.source);
        
        const img1 = article.img1 || '';
        const img2 = article.img2 || '';
        
        let imagesHTML = '';
        if (img1 && img2) {
             imagesHTML = `
                <div class="article-images-full">
                    <img src="${img1}" alt="Image 1 de l'article">
                    <img src="${img2}" alt="Image 2 de l'article">
                </div>
            `;
        } else if (img1) {
            imagesHTML = `
                <div class="article-images-full" style="grid-template-columns: 1fr;">
                    <img src="${img1}" alt="Image de l'article">
                </div>
            `;
        }
        
        // Trouver l'index de l'article actuellement affiché pour l'exclure dans le filtre
        currentArticleIndex = allArticlesData.titre.findIndex(t => t === title);

        // NOUVEAU : Rendre les articles similaires
        const similarArticlesHTML = renderSimilarArticles(article, currentArticleIndex);


        container.innerHTML = `
            <div class="article-header">
                <a href="article.html" class="return-button">← Retour aux articles</a>
                <span class="subject-badge">${subject}</span>
                <h1>${title}</h1>
                <p>Date : ${article.createdAt ? new Date(article.createdAt).toLocaleDateString('fr-FR') : 'Inconnue'}</p>
            </div>
            
            ${imagesHTML}

            <div id="article-content-full">
                ${fullContent}
            </div>

            <div id="sources-section">
                <h3>Sources utilisées</h3>
                ${sourcesHTML}
            </div>
            
            ${similarArticlesHTML} 
            
            <a href="article.html" class="return-button">← Retour aux articles</a>
        `;

    } catch (e) {
        console.error("Erreur de traitement des données de l'article :", e);
        container.innerHTML = `
            <div style="text-align:center; margin-top:50px;">
                <p style="color:red;">Erreur de traitement des données de l'article. Le format stocké est invalide.</p>
                <a href="article.html" class="return-button">Retour à l'accueil</a>
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', loadFullArticle);
</script>
</body>
</html>